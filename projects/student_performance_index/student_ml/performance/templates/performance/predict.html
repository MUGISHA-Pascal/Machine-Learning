{% extends 'performance/base.html' %}

{% block title %}Predict - Student Performance Predictor{% endblock %}

{% block extra_css %}
<style>
    .form-group {
        margin-bottom: 25px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 10px;
        color: #000000;
        font-weight: 700;
        font-size: 16px;
    }
    
    .form-group input, .form-group select {
        width: 100%;
        padding: 14px;
        border: 3px solid #000000;
        background: #ffffff;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.1s;
    }
    
    .form-group input:focus, .form-group select:focus {
        outline: none;
        box-shadow: 4px 4px 0px #000000;
        transform: translate(-2px, -2px);
    }
    
    .form-group small {
        display: block;
        margin-top: 8px;
        color: #000000;
        font-weight: 600;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 25px;
    }
    
    .result-box {
        margin-top: 40px;
        padding: 40px;
        background: #90EE90;
        border: 4px solid #000000;
        box-shadow: 8px 8px 0px #000000;
        text-align: center;
        display: none;
    }
    
    .result-box h3 {
        margin-bottom: 20px;
        font-size: 24px;
        font-weight: 900;
        color: #000000;
    }
    
    .result-box .score {
        font-size: 64px;
        font-weight: 900;
        margin: 25px 0;
        color: #000000;
    }
    
    .result-box p {
        font-weight: 600;
        color: #000000;
    }
    
    .category-badge {
        display: inline-block;
        padding: 12px 24px;
        background: #FFD700;
        border: 3px solid #000000;
        box-shadow: 4px 4px 0px #000000;
        font-size: 18px;
        font-weight: 900;
        text-transform: uppercase;
        margin: 20px 0;
        color: #000000;
    }
    
    .category-description {
        margin-top: 20px;
        padding: 20px;
        background: #ffffff;
        border: 3px solid #000000;
        font-weight: 600;
        color: #000000;
    }
    
    .result-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 30px;
        text-align: left;
    }
    
    .result-item {
        padding: 25px;
        background: #ffffff;
        border: 3px solid #000000;
        box-shadow: 4px 4px 0px #000000;
    }
    
    .result-item h4 {
        font-size: 16px;
        font-weight: 900;
        margin-bottom: 15px;
        color: #000000;
        text-transform: uppercase;
    }
    
    .result-item .value {
        font-size: 42px;
        font-weight: 900;
        color: #000000;
    }
    
    .result-item .label {
        font-size: 14px;
        font-weight: 700;
        color: #000000;
        margin-top: 10px;
    }
    
    @media (max-width: 768px) {
        .result-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<h2 style="color: #000000; margin-bottom: 30px; font-weight: 900; font-size: 28px;">Predict Student Performance</h2>

<div id="alertBox"></div>

<form id="predictForm">
    <div class="form-grid">
        <div class="form-group">
            <label for="hours_studied">Hours Studied (per week)</label>
            <input type="number" id="hours_studied" name="hours_studied" min="0" max="168" step="0.5" required>
            <small>Range: 0-168 hours</small>
        </div>
        
        <div class="form-group">
            <label for="previous_scores">Previous Scores</label>
            <input type="number" id="previous_scores" name="previous_scores" min="0" max="100" required>
            <small>Range: 0-100</small>
        </div>
        
        <div class="form-group">
            <label for="extracurricular">Extracurricular Activities</label>
            <select id="extracurricular" name="extracurricular" required>
                <option value="">Select...</option>
                <option value="true">Yes</option>
                <option value="false">No</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="sleep_hours">Sleep Hours (per day)</label>
            <input type="number" id="sleep_hours" name="sleep_hours" min="0" max="24" step="0.5" required>
            <small>Range: 0-24 hours</small>
        </div>
        
        <div class="form-group">
            <label for="sample_papers">Sample Papers Practiced</label>
            <input type="number" id="sample_papers" name="sample_papers" min="0" max="100" required>
            <small>Range: 0-100</small>
        </div>
    </div>
    
    <div style="margin-top: 35px; text-align: center;">
        <button type="submit" class="btn" id="predictBtn" style="font-size: 18px; padding: 16px 40px;">Predict Performance</button>
    </div>
</form>

<div class="loading" id="loading">
    <div class="spinner"></div>
    <p style="margin-top: 20px; color: #000000; font-weight: 700;">Predicting...</p>
</div>

<div class="result-box" id="resultBox">
    <h3>Prediction Results</h3>
    
    <div class="result-grid">
        <div class="result-item">
            <h4>Student Category</h4>
            <div class="category-badge" id="studentCategory">--</div>
            <div class="category-description" id="categoryDescription">--</div>
        </div>
        
        <div class="result-item" style="text-align: center;">
            <h4>Performance Index</h4>
            <div class="value" id="predictedScore">--</div>
            <div class="label">Predicted Score (0-100)</div>
        </div>
    </div>
    
    <p style="margin-top: 30px;">The model analyzes study patterns, sleep habits, and preparation to provide both a category classification and performance prediction.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.getElementById('predictForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const form = e.target;
    const formData = {
        hours_studied: parseFloat(form.hours_studied.value),
        previous_scores: parseFloat(form.previous_scores.value),
        extracurricular: form.extracurricular.value,
        sleep_hours: parseFloat(form.sleep_hours.value),
        sample_papers: parseFloat(form.sample_papers.value)
    };
    
    const alertBox = document.getElementById('alertBox');
    const loading = document.getElementById('loading');
    const resultBox = document.getElementById('resultBox');
    const predictBtn = document.getElementById('predictBtn');
    
    // Hide previous results
    alertBox.innerHTML = '';
    resultBox.style.display = 'none';
    
    // Show loading
    loading.style.display = 'block';
    predictBtn.disabled = true;
    
    try {
        const response = await fetch('/predict-ajax/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        // Debug: Log response status
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers.get('content-type'));
        
        // Check if response is JSON
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('Non-JSON response received:', text.substring(0, 500));
            throw new Error('Server returned HTML instead of JSON. Check if the endpoint exists and model is trained.');
        }
        
        const data = await response.json();
        
        // Debug: Log the response
        console.log('API Response:', data);
        
        loading.style.display = 'none';
        predictBtn.disabled = false;
        
        if (data.success) {
            // Update category
            const categoryElement = document.getElementById('studentCategory');
            const categoryDescElement = document.getElementById('categoryDescription');
            const scoreElement = document.getElementById('predictedScore');
            
            // Check if category data exists
            if (data.student_category && data.category_description) {
                // Format category name (replace underscores with spaces, capitalize)
                const formattedCategory = data.student_category
                    .split('_')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ');
                
                categoryElement.textContent = formattedCategory;
                categoryDescElement.textContent = data.category_description;
                
                // Color code the category badge based on type
                const categoryColors = {
                    'high_performer': '#90EE90',
                    'balanced_achiever': '#87CEEB',
                    'natural_talent': '#FFD700',
                    'hard_worker': '#FFA500',
                    'well_prepared': '#98FB98',
                    'average_student': '#D3D3D3',
                    'burnout_risk': '#FF6B6B',
                    'underachiever': '#FFB6C1',
                    'struggling': '#FFA07A',
                    'needs_support': '#FF4500'
                };
                
                categoryElement.style.background = categoryColors[data.student_category] || '#FFD700';
            } else {
                // Fallback if category data is missing
                categoryElement.textContent = 'Not Available';
                categoryDescElement.textContent = 'Please retrain the model to enable category predictions.';
                categoryElement.style.background = '#D3D3D3';
                
                console.warn('Category data missing. Model may need retraining.');
            }
            
            // Always show score
            scoreElement.textContent = data.predicted_performance_index || data.Predicted_performance_index || '--';
            
            resultBox.style.display = 'block';
            
            // Scroll to result
            resultBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
            alertBox.innerHTML = `<div class="alert alert-error">${data.error || 'Prediction failed'}</div>`;
        }
    } catch (error) {
        loading.style.display = 'none';
        predictBtn.disabled = false;
        console.error('Prediction error:', error);
        alertBox.innerHTML = `<div class="alert alert-error">Error: ${error.message}. Check browser console for details.</div>`;
    }
});
</script>
{% endblock %}
